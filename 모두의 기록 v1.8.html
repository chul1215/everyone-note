<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모두의 기록</title>
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="모두의 기록">
  <link rel="apple-touch-icon" href="icon-192x192.png"> <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:#fafafa; color:#333; }
    button { cursor:pointer; }
    .main-screen {
      display:flex; flex-direction:column; justify-content:center; align-items:center;
      height:100vh; text-align:center;
    }
    .main-title { font-size:48px; font-weight:600; margin-bottom:10px; }
    .main-subtitle { font-size:16px; color:#666; margin-bottom:50px; }
    .start-button { padding:16px 40px; font-size:18px; background:#333; color:#fff; border:none; border-radius:4px; }
    .editor-screen { display:none; height:100vh; }
    .container { display:flex; height:100%; width:100%; }
    .sidebar { width:250px; background:#f5f5f5; border-right:1px solid #e0e0e0; display:flex; flex-direction:column; }
    .sidebar-header { padding:20px; border-bottom:1px solid #e0e0e0; }
    .sidebar-title { font-size:18px; font-weight:500; }
    .sidebar-subtitle { font-size:12px; color:#666; margin-top:5px; }
    .new-note-btn { margin:10px; padding:10px; background:#333; color:#fff; border:none; border-radius:4px; }
    .sidebar-menu { flex:1; overflow-y:auto; }
    .menu-item { display:flex; justify-content:space-between; align-items:center; padding:12px 20px; border-bottom:1px solid #eee; }
    .menu-item.active { background:#fff; font-weight:500; }
    .menu-item button { background:none; border:none; color:#333; font-size:16px; }
    .sidebar-footer { padding:10px; border-top:1px solid #e0e0e0; display:flex; flex-direction:column; gap:5px; }
    .sidebar-footer button { padding:8px; background:#666; color:#fff; border:none; border-radius:4px; }
    .main-content-area { flex:1; display:flex; flex-direction:column; }
    .content-header { display:flex; justify-content:space-between; align-items:center; padding:20px; border-bottom:1px solid #e0e0e0; }
    #noteTitle { border:none; font-size:22px; font-weight:500; width:70%; background:none; }
    .view-toggle { display:flex; gap:10px; }
    .toggle-btn { padding:6px 12px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px; }
    .toggle-btn.active { background:#333; color:#fff; border-color:#333; }
    .editor-container { display:flex; flex:1; }
    .editor-pane { flex:1; padding:20px; border-right:1px solid #e0e0e0; }
    #editor { width:100%; height:100%; border:none; outline:none; font-family:'Consolas',monospace; font-size:14px; line-height:1.6; resize:none; white-space:pre-wrap; }
    .preview-pane { flex:1; padding:20px; background:#fafafa; overflow-y:auto; }
    .preview-content { max-width:800px; margin:0 auto; }
    .calendar-view { display:none; flex:1; padding:20px; }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-nav button { padding:6px 12px; background:#f5f5f5; border:1px solid #ddd; border-radius:4px; }
    .calendar-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:1px; background:#ddd; }
    .calendar-day-header { background:#f5f5f5; padding:10px; text-align:center; font-weight:500; }
    .calendar-day { background:#fff; min-height:80px; padding:8px; position:relative; cursor:pointer; }
    .calendar-day.other-month { background:#fafafa; color:#ccc; cursor:default; }
    .calendar-day.today { background:#e0f7fa; }
    .calendar-day-number { font-weight:500; }
    .calendar-day-content { position:absolute; bottom:4px; right:4px; font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div id="mainScreen" class="main-screen">
    <div>
      <h1 class="main-title">모두의 기록</h1>
      <p class="main-subtitle">K.Chul</p>
      <button class="start-button" onclick="startWriting()">작성하기</button>
    </div>
  </div>
  <div id="editorScreen" class="editor-screen">
    <div class="container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <div class="sidebar-title">모두의 기록</div>
          <div class="sidebar-subtitle">K.Chul</div>
        </div>
        <button class="new-note-btn" onclick="createNewNote()">새 노트</button>
        <div id="notesList" class="sidebar-menu"></div>
        <div class="sidebar-footer">
          <button onclick="exportToPDF()">PDF 저장</button>
          <button onclick="exportAsMD()">MD 저장</button>
          <button onclick="exportData()">JSON 내보내기</button>
          <button onclick="document.getElementById('importFile').click()">가져오기</button>
          <input type="file" id="importFile" accept=".json,.md" style="display:none;" onchange="importData(event)">
          <button onclick="backToMain()">메인으로</button>
        </div>
      </aside>
      <main class="main-content-area">
        <div class="content-header">
          <input type="text" id="noteTitle" placeholder="제목 없음">
          <div class="view-toggle">
            <button class="toggle-btn active" onclick="toggleView('editor')">에디터</button>
            <button class="toggle-btn" onclick="toggleView('calendar')">캘린더</button>
          </div>
        </div>
        <div id="editorView" class="editor-container">
          <div class="editor-pane">
            <textarea id="editor" placeholder="마크다운으로 작성하세요..."></textarea>
          </div>
          <div class="preview-pane">
            <div id="preview" class="preview-content"></div>
          </div>
        </div>
        <div id="calendarView" class="calendar-view">
          <div class="calendar-header">
            <h2 id="calendarMonth"></h2>
            <div class="calendar-nav">
              <button onclick="changeMonth(-1)">이전</button>
              <button onclick="changeMonth(0)">오늘</button>
              <button onclick="changeMonth(1)">다음</button>
            </div>
          </div>
          <div id="calendarGrid" class="calendar-grid"></div>
        </div>
      </main>
    </div>
  </div>
  <script>
    // NanumGothic font for jsPDF (Base64)
    const nanumGothic = 'AAEAAAARAQAABAAQRFNJRwAAAAAAA...'; // 실제 폰트 데이터는 매우 길어 생략합니다.

    document.addEventListener('DOMContentLoaded', () => {
      loadNotes(); 
      if (document.getElementById('calendarView').style.display === 'block') {
        renderCalendar();
      }
      document.getElementById('editor').addEventListener('input', () => { updatePreview(); saveCurrentNote(); });
      document.getElementById('noteTitle').addEventListener('input', saveCurrentNote);
    });

    function startWriting() { 
      document.getElementById('mainScreen').style.display='none'; 
      document.getElementById('editorScreen').style.display='block'; 
      if (!notes.length) {
        createNewNote();
      } else if (!currentNoteId) {
        selectNote(notes[0].id);
      }
    }
    function backToMain() { document.getElementById('mainScreen').style.display='flex'; document.getElementById('editorScreen').style.display='none'; }
    
    let notes = JSON.parse(localStorage.getItem('markdownNotes'))||[];
    let currentNoteId = null;
    let currentMonth = new Date();

    function parseMarkdown(md) {
      // breaks: true 옵션을 추가하여 엔터 한 번에 <br> 태그가 들어가도록 설정
      return marked.parse(md, { breaks: true });
    }

    function updatePreview(){
        if(currentNoteId) {
            document.getElementById('preview').innerHTML=parseMarkdown(document.getElementById('editor').value);
        }
    }
    
    function formatDate(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
    
    function createNewNote(dateKey){
        const date = dateKey ? new Date(dateKey + 'T00:00:00') : new Date();
        const iso = date.toISOString();
        const note={id:Date.now(),title:formatDate(date),content:'',createdAt:iso,updatedAt:iso};
        notes.unshift(note);
        saveNotes();
        loadNotes();
        selectNote(note.id);
    }    
    
    function selectNote(id){
        currentNoteId=id;
        const n=notes.find(x=>x.id===id);
        document.getElementById('noteTitle').value=n.title;
        document.getElementById('editor').value=n.content;
        updatePreview();
        highlightActive();
    }    
    
    function highlightActive(){
        document.querySelectorAll('.menu-item').forEach(el=>el.classList.remove('active'));
        const activeEl = document.querySelector(`.menu-item[data-note-id="${currentNoteId}"]`);
        if (activeEl) {
          activeEl.classList.add('active');
          activeEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }    
    
    function saveCurrentNote(){
        if(!currentNoteId)return;
        const n=notes.find(x=>x.id===currentNoteId);
        if (!n) return;
        n.title=document.getElementById('noteTitle').value||formatDate(new Date());
        n.content=document.getElementById('editor').value;
        n.updatedAt=new Date().toISOString();
        saveNotes();
        loadNotes(); // This re-sorts and re-renders the list
        highlightActive();
    }
    
    function saveNotes(){localStorage.setItem('markdownNotes',JSON.stringify(notes));}    
    
    function loadNotes(){
        const list=document.getElementById('notesList');
        list.innerHTML='';
        notes.sort((a,b)=>new Date(b.updatedAt)-new Date(a.updatedAt));
        notes.forEach(n=>{
            const d=document.createElement('div');
            d.className='menu-item';
            d.dataset.noteId=n.id;
            const titleSpan = document.createElement('span');
            titleSpan.textContent = n.title;
            d.appendChild(titleSpan);

            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteNote(n.id);
            };
            d.appendChild(deleteBtn);

            d.onclick=()=>selectNote(n.id);
            list.appendChild(d);
        });
        highlightActive();
    }
    
    function deleteNote(id){
        if(!confirm('삭제하시겠습니까?'))return;
        notes=notes.filter(x=>x.id!==id);
        saveNotes();
        
        if (currentNoteId === id) {
            currentNoteId = null;
            document.getElementById('noteTitle').value = '';
            document.getElementById('editor').value = '';
            updatePreview();
        }

        loadNotes();

        if(notes.length > 0) {
            if (!currentNoteId) {
                selectNote(notes[0].id);
            }
        } else {
            // No notes left, clear the editor area
            document.getElementById('noteTitle').value = '';
            document.getElementById('editor').value = '';
            document.getElementById('preview').innerHTML = '';
        }
        
        if (document.getElementById('calendarView').style.display === 'block') {
            renderCalendar();
        }
    }
    
    function renderCalendar(){
        const year=currentMonth.getFullYear(),month=currentMonth.getMonth();
        document.getElementById('calendarMonth').textContent=`${year}년 ${month+1}월`;
        const grid=document.getElementById('calendarGrid');
        grid.innerHTML='';
        ['일','월','화','수','목','금','토'].forEach(d=>{const hd=document.createElement('div');hd.className='calendar-day-header';hd.textContent=d;grid.appendChild(hd);});
        const first=new Date(year,month,1).getDay(),last=new Date(year,month+1,0).getDate(),prevLast=new Date(year,month,0).getDate();
        for(let i=first-1;i>=0;i--)appendDay(prevLast-i,true, null);
        for(let d=1;d<=last;d++)appendDay(d,false, new Date(year, month, d));
        const total=42,used=first+last;
        for(let d=1;d<=total-used;d++)appendDay(d,true, null);
    }
    
    function appendDay(date,isOther, fullDate){
        const cell=document.createElement('div');
        cell.className='calendar-day';
        if(isOther)cell.classList.add('other-month');
        const num=document.createElement('div');
        num.className='calendar-day-number';
        num.textContent=date;
        cell.appendChild(num);
        if(!isOther && fullDate){
            const iso = fullDate.toISOString().split('T')[0];
            const count=notes.filter(n=>n.updatedAt.split('T')[0]===iso&&n.content.trim().length>0).length;
            if(count>0){
                const ct=document.createElement('div');
                ct.className='calendar-day-content';
                ct.textContent=`${count}개`;
                cell.appendChild(ct);
            }
            const today=new Date();
            if(date===today.getDate()&&currentMonth.getMonth()===today.getMonth()&&currentMonth.getFullYear()===today.getFullYear())cell.classList.add('today');
            cell.addEventListener('click',()=>onDateClick(`${fullDate.getFullYear()}-${String(fullDate.getMonth()+1).padStart(2, '0')}-${String(fullDate.getDate()).padStart(2, '0')}`));
        }
        document.getElementById('calendarGrid').appendChild(cell);
    }
    
    function changeMonth(dir){
        if (dir === 0) {
            currentMonth = new Date();
        } else {
            currentMonth.setMonth(currentMonth.getMonth() + dir);
        }
        renderCalendar();
    }
    
    function onDateClick(dateKey){
        const iso=new Date(dateKey + 'T00:00:00').toISOString().split('T')[0];
        const ex=notes.find(n=>n.updatedAt.split('T')[0]===iso&&n.content.trim().length>0);
        if(ex) {
            selectNote(ex.id);
        } else {
            createNewNote(dateKey);
        }
        toggleView('editor');
    }
    
    function toggleView(view){
        document.getElementById('editorView').style.display=view==='editor'?'flex':'none';
        document.getElementById('calendarView').style.display=view==='calendar'?'block':'none';
        document.querySelectorAll('.toggle-btn').forEach(b=>b.classList.remove('active'));
        document.querySelector(`.toggle-btn[onclick*="${view}"]`).classList.add('active');
        if(view==='calendar')renderCalendar();
    }
    
    function exportToPDF() {
        if (!currentNoteId) return alert('노트를 선택하세요.');
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const note = notes.find(x => x.id === currentNoteId);

        // Add Base64 font to jsPDF
        doc.addFileToVFS('NanumGothic.ttf', nanumGothic);
        doc.addFont('NanumGothic.ttf', 'NanumGothic', 'normal');
        doc.setFont('NanumGothic');

        const title = note.title;
        const content = document.getElementById('editor').value; // Use raw markdown content
        const lines = content.split('\n');
        let y = 20;

        doc.setFontSize(16);
        doc.text(title, 20, y);
        y += 10;
        doc.setFontSize(12);

        lines.forEach(line => {
            if (y > 280) {
                doc.addPage();
                y = 20; // Reset Y position for new page
            }
            // Use splitTextToSize for automatic wrapping
            const splitLines = doc.splitTextToSize(line, 170); // 170mm width
            doc.text(splitLines, 20, y);
            y += (splitLines.length * 7);
        });

        doc.save(`${note.title}.pdf`);
    }

    function exportAsMD(){
        if(!currentNoteId)return alert('노트를 선택하세요.');
        const n=notes.find(x=>x.id===currentNoteId);
        const b=new Blob([n.content],{type:'text/markdown;charset=utf-8'});
        const u=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=u;
        a.download=`${n.title}.md`;
        a.click();
        URL.revokeObjectURL(u);
    }
    
    function exportData(){
        const b=new Blob([JSON.stringify(notes,null,2)],{type:'application/json'});
        const u=URL.createObjectURL(b);
        const a=document.createElement('a');
        a.href=u;
        a.download='notes.json';
        a.click();
        URL.revokeObjectURL(u);
    }
    
    function importData(e){
        const f=e.target.files[0];
        if(!f)return;
        const r=new FileReader();
        r.onload=()=>{
            const text=r.result; 
            if(f.name.endsWith('.json')){
                try{
                    const importedNotes=JSON.parse(text);
                    if(Array.isArray(importedNotes)){
                        // Simple merge: add new notes, overwrite existing ones by title
                        const existingTitles = new Set(notes.map(n => n.title));
                        const newNotes = importedNotes.filter(n => !existingTitles.has(n.title));
                        notes = [...notes, ...newNotes];
                        
                        saveNotes();
                        loadNotes();
                        if (notes.length > 0) {
                           selectNote(notes[0].id);
                        }
                    }
                }catch{
                    alert('잘못된 JSON 파일 형식입니다.');
                }
            }else if(f.name.endsWith('.md')){
                const title=f.name.replace(/\.md$/,'');
                const iso=new Date().toISOString();
                const note={id:Date.now(),title,content:text,createdAt:iso,updatedAt:iso};
                notes.unshift(note);
                saveNotes();
                loadNotes();
                selectNote(note.id);
            }
            
            if (document.getElementById('calendarView').style.display === 'block') {
                renderCalendar();
            }
        };
        r.readAsText(f);
        e.target.value='';
    }  
  </script>
</body>
</html>